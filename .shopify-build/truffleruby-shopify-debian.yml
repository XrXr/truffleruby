---
containers:
  default:
    includes_source: false
    environment: build
    build:
      tag_using_path: .shopify-build/Dockerfile.debian
      env:
        PIPA_PIPELINE_TEMPLATE: dockerfile
        PIPA_DOCKERFILE: .shopify-build/Dockerfile.debian

shared:
  truffle_run: &truffle_run
    timeout: 30m
    cache:
      - path: dist
        required: true
        inherited: false
        upload: false

steps:
  - label: "Build TruffleRuby on Debian"
    high_concurrency: true
    timeout: 90m
    cache:
      - path: dist
        inherited: false
    run:
      - .shopify-build/build.sh
  - wait
  - <<: *truffle_run
    label: "Run Ruby language, command-line, and security specs"
    run:
      - .shopify-build/test-specs.sh :language :command_line :security
  - <<: *truffle_run
    label: Run Ruby core specs
    timeout: 30m
    run:
      - .shopify-build/test-specs.sh :core
  - <<: *truffle_run
    label: Run Ruby library specs
    run:
      - .shopify-build/test-specs.sh :library :library_cext
  - <<: *truffle_run
    label: Run Ruby C extension specs
    run:
      - .shopify-build/test-specs.sh :capi
  - <<: *truffle_run
    label: Run Truffle specs
    run:
      - .shopify-build/test-specs.sh :truffle :truffle_capi
  - <<: *truffle_run
    label: Run browser_sniffer tests
    run:
      - .shopify-build/test-browser_sniffer.sh
  - <<: *truffle_run
    label: Run i18n tests
    run:
      - .shopify-build/test-i18n.sh
  - <<: *truffle_run
    label: Run liquid tests
    timeout: 30m
    run:
      - .shopify-build/test-liquid.sh
  - <<: *truffle_run
    label: Run measured tests
    run:
      - .shopify-build/test-measured.sh
  - <<: *truffle_run
    label: Run money tests
    run:
      - .shopify-build/test-money.sh
  - <<: *truffle_run
    label: Run statsd-instrument tests
    run:
      - .shopify-build/test-statsd-instrument.sh

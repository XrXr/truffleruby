containers:
  default:
    includes_source: false
    environment: build
    build:
      tag_using_path: .shopify-build/Dockerfile.debian
      env:
        PIPA_PIPELINE_TEMPLATE: dockerfile
        PIPA_DOCKERFILE: .shopify-build/Dockerfile.debian

steps:
  - label: "Build TruffleRuby on Debian"
    high_cpu: true
    timeout: 90m
    artifact_paths:
      - /build/artifacts
    run:
      - truffle/build-linux.sh
  - wait
  - label: Run Ruby specs
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - truffle/test-specs.sh
  - label: Run Liquid tests
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - truffle/test-liquid.sh

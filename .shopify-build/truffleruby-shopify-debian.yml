containers:
  default:
    includes_source: false
    environment: build
    build:
      tag_using_path: .shopify-build/Dockerfile.debian
      env:
        PIPA_PIPELINE_TEMPLATE: dockerfile
        PIPA_DOCKERFILE: .shopify-build/Dockerfile.debian

steps:
  - label: "Build TruffleRuby on Debian"
    high_concurrency: true
    timeout: 90m
    artifact_paths:
      - /build/artifacts
    run:
      - .shopify-build/build-linux.sh
  - wait
  - label: Run Ruby language, command-line, and security specs
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-specs.sh :language :command_line :security
  - label: Run Ruby core specs
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-specs.sh :core
  - label: Run Ruby library specs
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-specs.sh :library :library_cext
  - label: Run Ruby C extension specs
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-specs.sh :capi
  - label: Run Truffle specs
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-specs.sh :truffle :truffle_capi
  - label: Run Liquid tests
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-liquid.sh

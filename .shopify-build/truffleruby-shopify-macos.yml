containers:
  default:
    anka: macos-xcode10.3:latest
  upload:
    environment: upload
    includes_source: false
    build:
      tag_using_path: .shopify-build/Dockerfile.upload
      env:
        PIPA_PIPELINE_TEMPLATE: dockerfile
        PIPA_DOCKERFILE: .shopify-build/Dockerfile.upload

steps:
  - label: Build TruffleRuby on MacOS
    timeout: 90m
    artifact_paths:
    - .shopify-build/artifacts
    run:
    - brew install openssl llvm@4
    - cd .shopify-build
    - ./build-macos.sh
  - wait
  - label: Run Ruby specs
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-specs.sh
  - label: Run Liquid tests
    timeout: 30m
    import_artifacts:
    - pattern: '*.tar.gz'
      into: archive
    run:
      - .shopify-build/test-liquid.sh
  - block: "Release to dev"
  - label: Upload to S3 and send PR to Shopify/dev
    timeout: 30m
    container: upload
    import_artifacts:
    - pattern: 'truffleruby*.tar.gz'
      into: rubies
    run:
    - |
      bash <<'EOS'
        set -ex

        # massage the archive into a form dev likes
        cd rubies
        dir_path=$(echo ./*.tar.gz | sed 's/.tar.gz//')
        version=$(echo ./*.tar.gz | sed -E 's/.*-macos-(.*)\.tar\.gz/\1/')
        output_tar="truffleruby-$version.tgz"

        tar -xf "$dir_path.tar.gz"

        cd "$dir_path"
        tar -czf "../$output_tar" $(ls)
      EOS
    - git clone git@github.com:Shopify/ruby-builder.git
    - mkdir ruby-builder/rubies
    - mv rubies/truffleruby*.tgz ruby-builder/rubies/
    - cd ruby-builder
    - gem install bundler -v "$(grep -A 1 "BUNDLED WITH" Gemfile.lock | tail -n 1)"
    - bundle install --without test --without development
    - bundle exec ruby bin/upload_bins_for_dev
